<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QA Test Results</title>
  <style>
    /* --- Styles remain the same --- */
    body { font-family: Arial, sans-serif; margin: 1rem 2rem; background-color: #f5f5f5; }
    h1 { margin-bottom: 0.5rem; }
    .summary { background-color: #fff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
    .controls { margin-bottom: 1.5rem; padding-left: 0.5rem; }
    .control-button { padding: 6px 12px; margin-right: 10px; font-size: 0.9em; cursor: pointer; background-color: #e7e7e7; border: 1px solid #ccc; border-radius: 4px; color: #333; }
    .control-button:hover { background-color: #ddd; }
    details { margin-bottom: 0.8rem; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 0.5rem; }
    summary { font-weight: bold; cursor: pointer; list-style: none; outline: none; }
    .explanation, .prompt { margin: 0.5rem 0; padding: 0.5rem; background-color: #eee; border-radius: 4px; word-wrap: break-word; white-space: pre-wrap; }
    .artifacts { margin: 0.5rem 0; padding: 0.5rem; }
    .artifact-link { display: inline-block; margin-right: 1rem; }
    .screenshots { display: flex; gap: 2rem; flex-wrap: wrap; margin: 1rem 0; }
    .screenshots img { max-width: 200px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; height: auto; vertical-align: top; }
    .screenshots > div { flex-shrink: 0; }
  </style>
</head>
<body>

<h1>QA Test Results</h1>
<div class="summary">
  <p><strong>Passed:</strong> {{ passed_count }} &nbsp;&nbsp;
     <strong>Failed:</strong> {{ failed_count }} &nbsp;&nbsp;
     <strong>Skipped:</strong> {{ skipped_count }}
  </p>
</div>

<div class="controls">
  <button id="open-all-btn" class="control-button">Open All</button>
  <button id="close-all-btn" class="control-button">Close All</button>
</div>
{% for test in tests %}
  {% set bgColor = "" %}
  {% if test.status == "pass" %}
    {% set bgColor = "#d4edda" %} {# Light green Bootstrap success style #}
  {% elif test.status == "fail" %}
    {% set bgColor = "#f8d7da" %} {# Light red Bootstrap danger style #}
  {% elif test.status == "skipped" %}
    {% set bgColor = "#e2e3e5" %} {# Light grey Bootstrap secondary style #}
  {% else %}
    {% set bgColor = "#fff" %}
  {% endif %}

  <details class="test-details" style="background-color: {{ bgColor }}; border-color: {{ 'darkgrey' if test.status == 'skipped' else '#ccc' }};">
    <summary>{{ test.name }} &mdash; {{ test.status|upper if test.status else 'UNKNOWN' }}</summary>

    <div class="explanation">
      <strong>Explanation:</strong> {{ test.explanation if test.explanation else 'N/A' }}
    </div>

    {% if test.prompt %}
    <div class="prompt">
      <strong>Original Prompt:</strong><pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.2em;">{{ test.prompt }}</pre>
    </div>
    {% endif %}

    <div class="artifacts">
      <h4>Artifacts</h4>
      {# Check if there are ANY artifacts before showing section #}
      {% if test.text_files or test.screenshots_prod or test.screenshots_preview %}
          {% if test.text_files %}
            <p>Text File(s):
              {% for txt in test.text_files %}
                <a class="artifact-link" href="artifacts/{{txt}}" download>{{txt}}</a>
              {% endfor %}
            </p>
          {% endif %}

          <div class="screenshots">
            {% if test.screenshots_prod %}
              <div>
                <p>Production Screenshot(s):</p>
                {% for img in test.screenshots_prod %}
                  <a href="artifacts/{{img}}" target="_blank">
                    <img src="artifacts/{{img}}" alt="Production screenshot" />
                  </a>
                {% endfor %}
              </div>
            {% endif %}
            {% if test.screenshots_preview %}
              <div>
                <p>Preview Screenshot(s):</p>
                {% for img in test.screenshots_preview %}
                  <a href="artifacts/{{img}}" target="_blank">
                    <img src="artifacts/{{img}}" alt="Preview screenshot" />
                  </a>
                {% endfor %}
              </div>
            {% endif %}
            {# --- Block for screenshots_single removed --- #}
          </div>
      {% else %}
           <p>No artifacts generated for this test.</p>
      {% endif %}
    </div>
  </details>
{% endfor %}

<script>
  function setAllDetails(openState) {
    const allDetails = document.querySelectorAll('details.test-details');
    allDetails.forEach(detail => {
      detail.open = openState;
    });
  }

  document.addEventListener('DOMContentLoaded', (event) => {
    const openAllButton = document.getElementById('open-all-btn');
    const closeAllButton = document.getElementById('close-all-btn');

    if (openAllButton) {
      openAllButton.addEventListener('click', () => setAllDetails(true));
    }
    if (closeAllButton) {
      closeAllButton.addEventListener('click', () => setAllDetails(false));
    }
  });
</script>
</body>
</html>